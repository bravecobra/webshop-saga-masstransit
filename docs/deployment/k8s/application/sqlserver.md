# Setup sql server

## Install

We use the helm chart to deploy SQL server [stable/mssql-linux](https://github.com/helm/charts/tree/master/stable/mssql-linux).

```bash
helm install -f webshop/sqlserver/sqlserverdb.yaml sqlserverdb stable/mssql-linux --namespace=webshop
# kubectl apply -f https://www.getambassador.io/yaml/consul/ambassador-consul-connector.yaml --namespace=webshop
```

* SQLServer [values.yaml](https://github.com/helm/charts/blob/master/stable/mssql-linux/values.yaml)

To gain access to sqlserverdb, we need the autogenerated password the helmchart created in a kubernetes secret called `sqlserverdb-mssql-linux-secret` in the `webshop` namespace.

```bash
printf $(kubectl get secret --namespace webshop sqlserverdb-mssql-linux-secret -o jsonpath="{.data.sapassword}" | base64 --decode);echo
```

## CLI

You can test that SQL Server is available by the service port with the following set of command:

```bash
kubectl run mssqlcli --image=microsoft/mssql-tools -ti --restart=Never --rm=true -- /bin/bash
sqlcmd -S sqlserverdb-mssql-linux.webshop,1433 -U sa
Password: <Enter Password for SA>
```

You should now have a prompt where we can execute SQL like:

```sql
select @@version;
```

## SSMS

To connect from SSMS, first forward the port to the k8s service.

```bash
kubectl port-forward service/sqlserverdb-mssql-linux 1433:1433 --namespace webshop
```

> Be sure to use `127.0.0.1,1433` for the server instead of `localhost,1433`
